[workspace]
authors = ["ehsanmok <ehsanmok@users.noreply.github.com>"]
channels = ["https://conda.modular.com/max-nightly", "conda-forge"]
name = "mojson"
platforms = ["linux-64", "osx-arm64"]
version = "0.1.0"

[activation]
# Auto-build FFI wrapper on environment activation (idempotent - skips if up-to-date)
scripts = ["src/cpu/simdjson_ffi/build.sh"]

[dependencies]
mojo = "<1.0"
simdjson = ">=4.2.4,<5"

[feature.dev.dependencies]
make = ">=4.4.1,<5"
gxx = ">=13"              # g++ for Linux (macOS uses system clang++ from Xcode CLT)
git = ">=2"               # For cloning cuJSON (optional, NVIDIA benchmarks only)

[feature.dev.pypi-dependencies]
gdown = ">=5.0"           # Google Drive CLI for downloading benchmark datasets

[environments]
default = { features = ["dev"], solve-group = "default" }

[tasks]
# Format
format = { cmd = "mojo format src tests benchmark/mojo" }
format-check = { cmd = "bash -c 'mojo format src tests benchmark/mojo && git diff --exit-code src tests benchmark/mojo || (echo \"Error: Code is not formatted. Run \\\"pixi run format\\\" to fix.\" && exit 1)'" }

# Build simdjson FFI (CPU backend)
build = "bash src/cpu/simdjson_ffi/build.sh"

# Download benchmark datasets from Google Drive (cuJSON datasets)
# Full folder: https://drive.google.com/drive/folders/1PkDEy0zWOkVREfL7VuINI-m9wJe45P2Q
download-twitter-large = "gdown -O benchmark/datasets/twitter_large_record.json 1mdF4HT7s0Jp4XZ0nOxY7lQpcwRZzCjE1"
download-walmart-large = "gdown -O benchmark/datasets/walmart_large_record.json 10vicgS7dPa4aL5PwEjqAvpAKCXYLblMt"
download-wiki-large = "gdown -O benchmark/datasets/wiki_large_record.json 1bXdzhfWSdrnpg9WKOeV-oanYIT2j4yLE"

# Build benchmark binaries
build-bench-cpu = { cmd = "mkdir -p benchmark/build && mojo build -I . -o benchmark/build/bench_cpu benchmark/mojo/bench_cpu.mojo", depends-on = ["build"] }
build-bench-gpu = { cmd = "mkdir -p benchmark/build && mojo build -I . -o benchmark/build/bench_gpu benchmark/mojo/bench_gpu.mojo", depends-on = ["build"] }
build-bench-simdjson = { cmd = "bash -c 'mkdir -p benchmark/build && CXX=$(if [[ $(uname) == Darwin ]]; then echo clang++; else echo g++; fi) && $CXX -O3 -std=c++17 -o benchmark/build/bench_simdjson benchmark/cpp/bench_simdjson.cpp -I$CONDA_PREFIX/include -L$CONDA_PREFIX/lib -lsimdjson -Wl,-rpath,$CONDA_PREFIX/lib'", depends-on = ["build"] }
build-cujson = "bash -c 'cd benchmark && if [ ! -d cuJSON ]; then echo \"Error: cuJSON not found. Download it first:\\n  cd benchmark && git clone https://github.com/AutomataLab/cuJSON.git\" && exit 1; fi && mkdir -p cuJSON/build && nvcc -O3 -w -std=c++17 -arch=sm_100 -o cuJSON/build/cujson_benchmark cuJSON/paper_reproduced/src/cuJSON-standardjson.cu'"

# Tests (includes examples)
tests = "mojo -I . tests/test_value.mojo && mojo -I . tests/test_parser.mojo && mojo -I . tests/test_serialize.mojo && mojo -I . tests/test_serde.mojo && mojo -I . tests/test_e2e.mojo && mojo -I . tests/test_gpu.mojo && mojo -I . examples/01_basic_parsing.mojo && mojo -I . examples/02_file_operations.mojo && mojo -I . examples/03_value_types.mojo && mojo -I . examples/04_gpu_parsing.mojo && mojo -I . examples/05_error_handling.mojo && mojo -I . examples/06_struct_serde.mojo && mojo -I . examples/07_ndjson.mojo && mojo -I . examples/08_lazy_parsing.mojo && mojo -I . examples/09_jsonpath.mojo && mojo -I . examples/10_schema_validation.mojo && mojo -I . examples/11_json_patch.mojo"
tests-cpu = "mojo -I . tests/test_value.mojo && mojo -I . tests/test_parser.mojo && mojo -I . tests/test_serialize.mojo && mojo -I . tests/test_serde.mojo && mojo -I . tests/test_e2e.mojo && mojo -I . examples/01_basic_parsing.mojo && mojo -I . examples/02_file_operations.mojo && mojo -I . examples/03_value_types.mojo && mojo -I . examples/05_error_handling.mojo && mojo -I . examples/06_struct_serde.mojo && mojo -I . examples/07_ndjson.mojo && mojo -I . examples/08_lazy_parsing.mojo && mojo -I . examples/09_jsonpath.mojo && mojo -I . examples/10_schema_validation.mojo && mojo -I . examples/11_json_patch.mojo"
tests-gpu = "mojo -I . tests/test_gpu.mojo && mojo -I . examples/04_gpu_parsing.mojo"
tests-e2e = "mojo -I . tests/test_e2e.mojo"
tests-e2e-gpu = "MOJSON_TEST_GPU=1 mojo -I . tests/test_e2e.mojo"

# Benchmarks - pass file path as argument, defaults to twitter.json
# Usage: pixi run bench-cpu path/to/file.json
#        pixi run bench-gpu path/to/file.json
bench-cpu = { cmd = "bash -c 'F=\"${1:-benchmark/datasets/twitter.json}\"; benchmark/build/bench_simdjson \"$F\" && echo && benchmark/build/bench_cpu \"$F\"' _", depends-on = ["build-bench-cpu", "build-bench-simdjson"] }
bench-gpu = { cmd = "bash -c 'benchmark/build/bench_gpu \"${1:-benchmark/datasets/twitter.json}\"' _", depends-on = ["build-bench-gpu"] }

# Run all GPU benchmarks (3 runs each, large datasets only)
# Usage: pixi run bench-gpu-all
bench-gpu-all = { cmd = "bash -c 'for i in 1 2 3; do for f in benchmark/datasets/*_large_*.json; do echo \"=== Run $i: $f ===\"; benchmark/build/bench_gpu \"$f\"; done; done'", depends-on = ["build-bench-gpu"] }

# Examples
example-basic = "mojo -I . examples/01_basic_parsing.mojo"
example-files = "mojo -I . examples/02_file_operations.mojo"
example-value = "mojo -I . examples/03_value_types.mojo"
example-gpu = "mojo -I . examples/04_gpu_parsing.mojo"
example-errors = "mojo -I . examples/05_error_handling.mojo"
example-serde = "mojo -I . examples/06_struct_serde.mojo"
example-ndjson = "mojo -I . examples/07_ndjson.mojo"
example-lazy = "mojo -I . examples/08_lazy_parsing.mojo"
example-jsonpath = "mojo -I . examples/09_jsonpath.mojo"
example-schema = "mojo -I . examples/10_schema_validation.mojo"
example-patch = "mojo -I . examples/11_json_patch.mojo"
examples = "mojo -I . examples/01_basic_parsing.mojo && mojo -I . examples/02_file_operations.mojo && mojo -I . examples/03_value_types.mojo && mojo -I . examples/04_gpu_parsing.mojo && mojo -I . examples/05_error_handling.mojo && mojo -I . examples/06_struct_serde.mojo && mojo -I . examples/07_ndjson.mojo && mojo -I . examples/08_lazy_parsing.mojo && mojo -I . examples/09_jsonpath.mojo && mojo -I . examples/10_schema_validation.mojo && mojo -I . examples/11_json_patch.mojo"

# GPU benchmark vs cuJSON (NVIDIA only, requires manual cuJSON download)
# Usage: pixi run bench-gpu-cujson -- path/to/file.json
# First: cd benchmark && git clone https://github.com/AutomataLab/cuJSON.git
bench-gpu-cujson = { cmd = "bash -c 'F=${1:-benchmark/datasets/twitter.json}; if [ ! -f benchmark/cuJSON/build/cujson_benchmark ]; then echo \"Error: cuJSON not built. Run: pixi run build-cujson\" && exit 1; fi; echo \"--- cuJSON ---\" && benchmark/cuJSON/build/cujson_benchmark -b \"$F\" && echo && echo \"--- mojson GPU ---\" && benchmark/build/bench_gpu \"$F\"' --", depends-on = ["build-bench-gpu"] }

